<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WhatsApp-style Realtime Chat (Firebase)</title>
  <style>
    :root{
      --wa-green:#075e54; --bg:#e5ddd5; --bubble-me:#dcf8c6; --bubble-other:#fff;
      --muted:#7b7b7b; --accent:#34b7f1;
      font-family: "Helvetica Neue", Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);-webkit-font-smoothing:antialiased}
    .app{height:100vh;display:flex;flex-direction:column;max-width:980px;margin:0 auto;background:var(--bg)}
    header{height:64px;background:var(--wa-green);color:#fff;display:flex;align-items:center;padding:8px 12px;gap:12px}
    .avatar{width:44px;height:44px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;color:var(--wa-green);font-weight:700;cursor:pointer}
    .title{font-size:16px;font-weight:700}
    .subtitle{font-size:12px;color:rgba(255,255,255,0.9)}
    .main{flex:1;display:flex;flex-direction:row;overflow:hidden}
    .left{width:300px;border-right:1px solid rgba(0,0,0,0.05);background:#f8f9f9;padding:12px;box-sizing:border-box}
    .right{flex:1;display:flex;flex-direction:column;align-items:stretch}
    .chat{flex:1;padding:18px;overflow:auto;background-image:url('https://i.ibb.co/D8g2Snp/whatsapp-bg.png');background-size:cover}
    .msg{max-width:74%;padding:10px 12px;margin:8px 0;border-radius:8px;position:relative;word-wrap:break-word;white-space:pre-wrap;box-shadow:0 1px 0 rgba(0,0,0,0.06)}
    .msg.me{margin-left:auto;background:var(--bubble-me);border-bottom-right-radius:2px}
    .msg.other{margin-right:auto;background:var(--bubble-other);border-bottom-left-radius:2px}
    .msg .meta{font-size:11px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .reply-box{background:rgba(0,0,0,0.05);padding:6px 8px;border-left:3px solid var(--accent);margin-bottom:6px;border-radius:6px;font-size:13px;color:#333;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .controls{position:absolute;left:8px;top:6px;display:flex;gap:6px;opacity:0;transition:opacity .15s}
    .msg:hover .controls{opacity:1}
    .icon-btn{background:rgba(0,0,0,0.06);border:none;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:12px}
    .composer{padding:12px;background:#f0f0f0;border-top:1px solid rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:8px}
    .reply-preview{display:flex;align-items:center;gap:8px;padding:8px;background:#fafafa;border-left:3px solid var(--accent);border-radius:6px}
    .input-row{display:flex;gap:8px}
    .input{flex:1;padding:12px;border-radius:20px;border:1px solid rgba(0,0,0,0.08);outline:none}
    .btn{background:var(--wa-green);color:white;border:none;padding:10px 14px;border-radius:50%;cursor:pointer}
    .btn:disabled{background:gray;cursor:not-allowed}
    .user-list{display:flex;flex-direction:column;gap:8px}
    .user-card{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#fff;cursor:pointer}
    .user-card .meta{font-size:13px;color:#333}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Chat App">
    <header>
      <div id="headerAvatar" class="avatar" title="Klik untuk chat privat admin">--</div>
      <div style="flex:1">
        <div class="title" id="roomTitle">Chat Room</div>
        <div class="subtitle" id="statusLine">Online — ruang publik</div>
      </div>
      <div class="small" id="openHours">06:00 — 01:00</div>
    </header>

    <div class="main">
      <div class="left">
        <div style="margin-bottom:8px;font-weight:700">Peserta</div>
        <div class="user-list" id="userList"></div>
        <div style="margin-top:12px" class="small">Klik avatar admin untuk chat privat.</div>
      </div>

      <div class="right">
        <div id="chatArea" class="chat" aria-live="polite"></div>

        <div class="composer">
          <div id="replyPreview" class="reply-preview" style="display:none">
            <div style="font-weight:700" id="rpUser"></div>
            <div style="flex:1;color:#333" id="rpText"></div>
            <button id="rpCancel" class="icon-btn">×</button>
          </div>

          <div class="input-row">
            <input id="textInput" class="input" placeholder="Tulis pesan..." aria-label="Tulis pesan" />
            <button id="sendBtn" class="btn" title="Kirim">▶</button>
          </div>
          <div class="small" id="hint">Tekan Enter atau klik kirim. Klik pesan untuk membalas.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getDatabase, ref, push, onChildAdded, update, onValue, get
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyB_1FfccKqXdet00LJyYLY7K4FenvgerhU",
      authDomain: "webku-bf4dd.firebaseapp.com",
      databaseURL: "https://webku-bf4dd-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "webku-bf4dd",
      storageBucket: "webku-bf4dd.appspot.com",
      messagingSenderId: "873622953345",
      appId: "1:873622953345:web:50b0dcfc58b27b9b1c5c80",
      measurementId: "G-30ZPKLVZYE"
    };

    // ---------- INIT ----------
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app, firebaseConfig.databaseURL);

    // ---------- DOM ----------
    const chatArea = document.getElementById('chatArea');
    const textInput = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    const replyPreview = document.getElementById('replyPreview');
    const rpUser = document.getElementById('rpUser');
    const rpText = document.getElementById('rpText');
    const rpCancel = document.getElementById('rpCancel');
    const statusLine = document.getElementById('statusLine');
    const headerAvatar = document.getElementById('headerAvatar');
    const userListEl = document.getElementById('userList');
    const hintEl = document.getElementById('hint');
    const roomTitle = document.getElementById('roomTitle');

    // ---------- USER ----------
    let username = localStorage.getItem('chat_username_v1');
    if(!username){
      // modal-like prompt loop until user gives a name (prevents empty)
      while(true){
        const v = prompt('Masukkan nama Anda (tidak kosong):', 'Anonim');
        if(v && v.trim()){ username = v.trim(); break; }
      }
      localStorage.setItem('chat_username_v1', username);
    }
    headerAvatar.textContent = username.slice(0,2).toUpperCase();
    const isAdmin = username.toLowerCase() === 'admin';

    // ---------- CHAT & PRESENCE ----------
    let currentChatId = 'public';          // 'public' or private chat id
    function privateChatId(a,b){ const arr=[a,b].sort(); return `private_${arr[0]}_${arr[1]}`; }
    let rendered = new Set();             // message ids rendered for current chat
    const PRESENCE_PATH = `presence/${username}`;

    // announce presence (simple)
    function announcePresence(){
      update(ref(db, `presence/${username}`), { lastActive: Date.now(), online: true }).catch(()=>{});
    }
    announcePresence();
    setInterval(announcePresence, 20_000);

    // ---------- ROOM STATE ----------
    const ROOM_STATE_REF = ref(db, 'room/state');
    let roomClosed = false;
    onValue(ROOM_STATE_REF, s => {
      const v = s.val() || {};
      roomClosed = !!v.closed;
      refreshOpenState();
    });

    // open hours logic
    const ROOM_OPEN = 6, ROOM_CLOSE = 1;
    function isWithinOpenHours(d = new Date()){
      const h = d.getHours();
      return (h >= ROOM_OPEN) || (h < ROOM_CLOSE);
    }
    function refreshOpenState(){
      const open = isWithinOpenHours() && !roomClosed;
      sendBtn.disabled = !open;
      textInput.disabled = !open;
      if(!open){
        hintEl.textContent = 'Ruang TUTUP (06:00 — 01:00) atau ditutup admin.';
        hintEl.style.color = '#c0392b';
      } else {
        hintEl.textContent = 'Tekan Enter atau klik kirim. Klik pesan untuk membalas.';
        hintEl.style.color = '';
      }
    }
    setInterval(refreshOpenState, 30_000);
    refreshOpenState();

    // ---------- SUBSCRIBE / RENDER ----------
    function subscribeToChat(chatId){
      // reset UI state
      currentChatId = chatId;
      rendered = new Set();
      chatArea.innerHTML = '';
      roomTitle.textContent = (chatId === 'public') ? 'Chat Room' : `Chat privat — ${chatId.replace('private_','')}`;
      // listen child_added
      const messagesRef = ref(db, `chats/${chatId}/messages`);
      onChildAdded(messagesRef, snap => {
        const id = snap.key;
        const data = snap.val();
        if(rendered.has(id)) return;
        rendered.add(id);
        renderMessageNode(chatId, id, data);
        // mark delivered for this user (simple)
        update(ref(db, `chats/${chatId}/messages/${id}/delivered/${username}`), true).catch(()=>{});
        // mark seen quickly if not mine
        if(data.username !== username){
          update(ref(db, `chats/${chatId}/messages/${id}/seen/${username}`), true).catch(()=>{});
        }
      });
    }

    subscribeToChat('public');

    function renderMessageNode(chatId, id, data){
      const wrapper = document.createElement('div');
      wrapper.className = 'msg ' + (data.username === username ? 'me' : 'other');
      wrapper.dataset.id = `${chatId}__${id}`;

      // admin controls appear if current user is admin
      if(isAdmin){
        const controls = document.createElement('div'); controls.className='controls';
        const del = document.createElement('button'); del.className='icon-btn'; del.textContent='Hapus';
        del.addEventListener('click', e => { e.stopPropagation(); adminDeleteMessage(chatId,id); });
        const edit = document.createElement('button'); edit.className='icon-btn'; edit.textContent='Edit';
        edit.addEventListener('click', e => { e.stopPropagation(); adminEditMessage(chatId,id,data); });
        controls.appendChild(del); controls.appendChild(edit);
        wrapper.appendChild(controls);
      }

      if(data.reply && data.reply.username){
        const r = document.createElement('div'); r.className='reply-box';
        r.textContent = `${data.reply.username}: ${data.reply.text}`;
        wrapper.appendChild(r);
      }

      const body = document.createElement('div'); body.textContent = data.deleted ? 'Pesan dihapus' : (data.text || '');
      wrapper.appendChild(body);

      const meta = document.createElement('div'); meta.className='meta';
      const timeSpan = document.createElement('span'); timeSpan.textContent = data.time || new Date(data.createdAt || Date.now()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      meta.appendChild(timeSpan);
      if(data.username === username){
        const tick = document.createElement('span'); tick.style.marginLeft='8px';
        const delivered = data.delivered ? Object.keys(data.delivered).length > 0 : false;
        const seen = data.seen ? Object.keys(data.seen).length > 0 : false;
        if(!delivered) tick.textContent = '✓';
        else if(delivered && !seen) tick.textContent = '✓✓';
        else { tick.textContent = '✓✓'; tick.style.color = '#34b7f1'; }
        meta.appendChild(tick);
      }
      wrapper.appendChild(meta);

      wrapper.addEventListener('click', () => {
        if(data.deleted) return;
        // set reply
        setReply({ id, username: data.username, text: data.text });
      });

      chatArea.appendChild(wrapper);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // ---------- user list ----------
    onValue(ref(db, 'presence'), snap => {
      const val = snap.val() || {};
      userListEl.innerHTML = '';
      Object.keys(val).sort().forEach(u => {
        const card = document.createElement('div'); card.className='user-card';
        const av = document.createElement('div'); av.className='avatar'; av.textContent = u.slice(0,2).toUpperCase();
        av.addEventListener('click', e => { e.stopPropagation(); openPrivateChatWith(u); });
        const meta = document.createElement('div'); meta.innerHTML = `<div style="font-weight:700">${u}${u.toLowerCase()==='admin' ? ' <span style="color:#b9770e">(admin)</span>' : ''}</div><div class="small">last: ${timeFromTs(val[u]?.lastActive)}</div>`;
        card.appendChild(av); card.appendChild(meta);
        userListEl.appendChild(card);
      });
    });

    // ---------- reply UI ----------
    let replyingTo = null;
    function setReply(obj){
      replyingTo = obj;
      if(obj){
        rpUser.textContent = obj.username;
        rpText.textContent = obj.text.length > 160 ? obj.text.slice(0,160)+'…' : obj.text;
        replyPreview.style.display = 'flex';
      } else {
        replyPreview.style.display = 'none';
        rpUser.textContent = ''; rpText.textContent = '';
      }
      textInput.focus();
    }
    rpCancel.addEventListener('click', ()=> setReply(null));

    // ---------- send ----------
    async function sendMessage(){
      const text = textInput.value.trim();
      if(!text) return;
      if(!isWithinOpenHours() || roomClosed){
        alert('Ruang TUTUP (06:00—01:00) atau ditutup admin');
        return;
      }
      const chatId = currentChatId;
      const messagesPath = `chats/${chatId}/messages`;
      const payload = {
        username,
        text,
        createdAt: Date.now(),
        time: new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}),
        edited: false
      };
      if(replyingTo) payload.reply = { id: replyingTo.id, username: replyingTo.username, text: replyingTo.text };
      try {
        await push(ref(db, messagesPath), payload);
        textInput.value = '';
        setReply(null);
      } catch(err) {
        console.error('push error', err);
        alert('Gagal mengirim — cek koneksi / rules Firebase');
      }
    }
    sendBtn.addEventListener('click', sendMessage);
    textInput.addEventListener('keydown', e => { if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

    // ---------- admin actions ----------
    async function adminDeleteMessage(chatId, msgId){
      if(!confirm('Hapus pesan ini?')) return;
      const path = `chats/${chatId}/messages/${msgId}`;
      update(ref(db, path), { deleted: true, text: '' }).catch(()=>{});
    }
    async function adminEditMessage(chatId, msgId, data){
      const newText = prompt('Edit pesan:', data.text || '');
      if(newText === null) return;
      const path = `chats/${chatId}/messages/${msgId}`;
      update(ref(db, path), { text: newText, edited: true }).catch(()=>{});
    }

    // ---------- private chat ----------
    headerAvatar.addEventListener('click', ()=> openPrivateChatWith('admin'));
    function openPrivateChatWith(other){
      if(other === username){ alert('Itu Anda sendiri.'); return; }
      const chatId = privateChatId(username, other);
      currentChatId = chatId;
      chatArea.innerHTML = '';
      rendered = new Set();
      subscribeToChat(chatId);
      statusLine.textContent = `Chat privat — ${other}`;
    }

    // clicking room title goes back to public
    document.getElementById('roomTitle').addEventListener('click', ()=>{
      currentChatId = 'public';
      chatArea.innerHTML = '';
      rendered = new Set();
      subscribeToChat('public');
      statusLine.textContent = 'Online — ruang publik';
    });

    // ---------- mark presence end ----------
    window.addEventListener('beforeunload', ()=> {
      update(ref(db, PRESENCE_PATH), { lastActive: Date.now(), online: false }).catch(()=>{});
    });

    // bootstrap presence path set
    update(ref(db, PRESENCE_PATH), { lastActive: Date.now(), online: true }).catch(()=>{});

    // ensure initial public subscribe (already called earlier, but safe)
    // subscribeToChat('public'); // already called before

    // helper
    function timeFromTs(ts){
      if(!ts) return '--:--';
      return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }

    // ---------- initial user list + presence ensure ---------- 
    // ensure presence object for this user
    update(ref(db, `presence/${username}`), { lastActive: Date.now(), online: true }).catch(()=>{});
  </script>
</body>
</html>
