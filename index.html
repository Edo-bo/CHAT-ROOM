<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Room Realtime — Reply (WhatsApp style)</title>
  <style>
    :root{
      --bg1:#0f1724; --bg2:#071028;
      --muted:rgba(255,255,255,0.6);
      --accent-start:#06b6d4; --accent-end:#7c3aed;
      --me-bg: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .app{width:100%;max-width:1000px;height:80vh;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;display:grid;grid-template-rows:auto 1fr auto;gap:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
    header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px}
    header h1{margin:0;font-size:18px}
    header .sub{font-size:13px;color:var(--muted)}
    .messages{overflow:auto;padding:12px 16px;display:flex;flex-direction:column;gap:10px}
    .msg{
      max-width:78%;padding:10px;border-radius:12px;background:rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(0,0,0,0.4);
      position:relative;animation:pop .16s ease;
    }
    .msg.me{margin-left:auto;background:var(--me-bg);color:#021124}
    .meta{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .meta .name{font-weight:700}
    .meta .time{font-size:11px;color:rgba(255,255,255,0.6)}
    @keyframes pop{from{transform:translateY(6px);opacity:0}to{transform:none;opacity:1}}
    /* reply preview inside message (WhatsApp-like small box) */
    .reply-box{
      background:rgba(255,255,255,0.04);border-left:4px solid rgba(0,0,0,0.1);padding:8px;border-radius:8px;margin-bottom:8px;font-size:13px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    /* input area */
    .compose{display:flex;flex-direction:column;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));}
    .reply-preview{
      display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:rgba(0,0,0,0.25);margin-bottom:8px;
    }
    .reply-preview .meta{margin:0;color:#9bd7ff}
    .reply-preview .text{flex:1;color:var(--muted);font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-cancel{background:transparent;border:0;color:var(--muted);cursor:pointer;font-weight:700}
    .input-row{display:flex;gap:8px}
    .input{
      flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);outline:none;background:transparent;color:inherit;font-size:15px
    }
    .send{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent-end),var(--accent-start));font-weight:700;cursor:pointer}
    .hint{font-size:13px;color:var(--muted);text-align:center;padding:6px}
    .closed{display:none;text-align:center;padding:18px;color:#ffd6d6}
    /* small responsive */
    @media (max-width:720px){ .app{height:92vh;padding:8px} .messages{padding:8px} .msg{max-width:92%}}
    /* cursor pointer for clickable message (to reply) */
    .msg.clickable{cursor:pointer}
    .msg.clickable:hover{filter:brightness(1.03)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="app" role="application" aria-label="Chat Room">
      <header>
        <div>
          <h1>Chat Room</h1>
          <div class="sub">Realtime lewat Firebase — klik pesan untuk membalas</div>
        </div>
        <div class="sub">Jam buka: <strong>06:00 — 01:00</strong></div>
      </header>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div class="compose" id="composer">
        <div id="closed" class="closed">⏳ Ruang TUTUP. Buka pukul 06:00 — 01:00</div>

        <div id="replyPreview" class="reply-preview" style="display:none;">
          <div style="min-width:8px;border-left:4px solid rgba(255,255,255,0.6);height:36px;"></div>
          <div style="flex:1">
            <div class="meta tiny" id="rpUser"></div>
            <div class="text" id="rpText"></div>
          </div>
          <button class="btn-cancel" id="cancelReply" title="Batal balas">×</button>
        </div>

        <div class="input-row">
          <input id="textInput" class="input" placeholder="Tulis pesan..." aria-label="Tulis pesan" />
          <button id="sendBtn" class="send">Kirim</button>
        </div>
        <div id="hint" class="hint">Tekan Enter atau klik Kirim. Klik pesan untuk membalas.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // --- Firebase config (dari kamu) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB_1FfccKqXdet00LJyYLY7K4FenvgerhU",
      authDomain: "webku-bf4dd.firebaseapp.com",
      databaseURL: "https://webku-bf4dd-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "webku-bf4dd",
      storageBucket: "webku-bf4dd.firebasestorage.app",
      messagingSenderId: "873622953345",
      appId: "1:873622953345:web:50b0dcfc58b27b9b1c5c80",
      measurementId: "G-30ZPKLVZYE"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const messagesRef = ref(db, 'messages');

    // --- DOM ---
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('textInput');
    const sendBtn = document.getElementById('sendBtn');
    const hintEl = document.getElementById('hint');
    const closedEl = document.getElementById('closed');
    const composerEl = document.getElementById('composer');

    const replyPreview = document.getElementById('replyPreview');
    const rpUser = document.getElementById('rpUser');
    const rpText = document.getElementById('rpText');
    const cancelReplyBtn = document.getElementById('cancelReply');

    // --- User ---
    let username = localStorage.getItem('username_v1');
    if(!username){
      username = prompt('Masukkan nama Anda:') || ('User'+Math.floor(Math.random()*900+100));
      localStorage.setItem('username_v1', username);
    }

    // --- Open hours ---
    const ROOM_OPEN = 6; // 06:00
    const ROOM_CLOSE = 1; // 01:00
    function isRoomOpen(date = new Date()){
      const h = date.getHours();
      return (h >= ROOM_OPEN) || (h < ROOM_CLOSE);
    }
    function refreshOpenState(){
      const open = isRoomOpen();
      if(!open){
        closedEl.style.display = 'block';
        inputEl.disabled = true;
        sendBtn.disabled = true;
      } else {
        closedEl.style.display = 'none';
        inputEl.disabled = false;
        sendBtn.disabled = false;
      }
    }
    refreshOpenState();
    setInterval(refreshOpenState, 30_000);

    // --- Reply state ---
    let replyingTo = null; // {id, username, text}

    function setReply(to){
      replyingTo = to;
      if(to){
        rpUser.textContent = to.username;
        rpText.textContent = to.text.length > 120 ? to.text.slice(0,120) + '…' : to.text;
        replyPreview.style.display = 'flex';
        inputEl.focus();
      } else {
        replyPreview.style.display = 'none';
        rpUser.textContent = '';
        rpText.textContent = '';
      }
    }
    cancelReplyBtn.addEventListener('click', ()=> setReply(null));

    // --- Sending message ---
    function sendMessage(){
      const text = inputEl.value.trim();
      if(!text) return;
      if(!isRoomOpen()){
        hintEl.textContent = 'Ruang saat ini TERTUTUP. Buka pukul 06:00 — 01:00';
        hintEl.style.color = '#ffb4b4';
        return;
      }
      const now = new Date();
      const timeStr = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
      const payload = {
        username,
        text,
        time: timeStr,
        createdAt: Date.now()
      };
      if(replyingTo){
        payload.reply = {
          id: replyingTo.id,
          username: replyingTo.username,
          text: replyingTo.text
        };
      }

      push(messagesRef, payload)
        .then(()=> {
          inputEl.value = '';
          setReply(null);
          hintEl.textContent = 'Terkirim ✓';
          hintEl.style.color = '#9be6c3';
          setTimeout(()=>{ hintEl.textContent = 'Tekan Enter atau klik Kirim. Klik pesan untuk membalas.'; hintEl.style.color=''; }, 1200);
        })
        .catch(err=>{
          console.error(err);
          hintEl.textContent = 'Gagal mengirim — cek koneksi.';
          hintEl.style.color = '#ffb4b4';
        });
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    // --- Render message helper ---
    function createMessageNode(id, data){
      const el = document.createElement('div');
      el.className = 'msg clickable' + (data.username === username ? ' me' : '');
      el.setAttribute('data-id', id);

      // If this message is a reply to another message, show small reply box
      if(data.reply && (data.reply.text || data.reply.username)){
        const r = document.createElement('div');
        r.className = 'reply-box';
        r.innerHTML = `<strong style="display:inline-block;margin-right:6px;color:#a6e3ff">${escapeHtml(data.reply.username)}</strong><span style="opacity:0.85">${escapeHtml(data.reply.text)}</span>`;
        el.appendChild(r);
      }

      // meta (name + time)
      const meta = document.createElement('div');
      meta.className = 'meta';
      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.textContent = data.username;
      const timeSpan = document.createElement('span');
      timeSpan.className = 'time';
      timeSpan.textContent = data.time || '';
      meta.appendChild(nameSpan);
      meta.appendChild(timeSpan);
      el.appendChild(meta);

      // body
      const body = document.createElement('div');
      body.className = 'body';
      body.textContent = data.text;
      el.appendChild(body);

      // click to reply: when clicked, set replyingTo with this message
      el.addEventListener('click', (ev)=>{
        // avoid when clicking on input or send etc.
        setReply({ id, username: data.username, text: data.text });
        // scroll input into view
        inputEl.scrollIntoView({behavior:'smooth', block:'center'});
      });

      return el;
    }

    function escapeHtml(s){
      if(!s) return '';
      return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
    }

    // --- Realtime listener ---
    onChildAdded(messagesRef, (snap) => {
      const id = snap.key;
      const data = snap.val();
      // Prevent duplicate if already exists
      if(document.querySelector(`.msg[data-id="${id}"]`)) return;
      const node = createMessageNode(id, data);
      messagesEl.appendChild(node);
      // keep last 500 messages to avoid huge DOM — optional purge
      while(messagesEl.children.length > 700){ messagesEl.removeChild(messagesEl.firstChild); }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });

    // Seed initial hint and focus
    inputEl.focus();

    // show online indicator (simple)
    window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') messagesEl.scrollTop = messagesEl.scrollHeight; });

  </script>
</body>
</html>
